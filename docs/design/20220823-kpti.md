
# 内核地址隔离

**原理** 先切换到跳板页上的单页表微型内核，再从这个微型内核引导用户态。

本文描述了一种设计，目的是实现单页表内核和双页表内核的一致性。位于不同地址空间的任务被传递给一个公共地址空间（称为中转地址空间）上的独立调度器（称为中转内核），由这个内核进行中转调度。中转内核在主内核上表现为一个屏蔽中断的内核线程（即一个正常的任务）。

## 中转内核布局

| 内容
| -
| 共享用户上下文
| `execute`
| `trap`
| 中转内核入口
| 中转内核栈

## 中转内核编译

中转内核在编译时是主内核的一部分。主内核应该在自己的链接脚本上留一个页，然后将中转内核代码段直接链接到页中间的一个位置，保证页开头到中转内核入口之间足够容纳上表描述的内容（估计 1 KiB 够了）。中转内核代码段必须是可重定位的，可以直接手写汇编实现。

## 中转内核初始化

主内核依次拷贝 `execute` `trap` 到中转内核页上，并初始化一个中转内核上下文，内容包括：

- `sp` = 中转内核栈顶（如果中转页在最高虚页上，是 0）
- `a0` = 跳板页基地址/共享用户上下文基地址
- `a1` = `execute` 地址
- `a2` = `trap` 地址
- `sepc` = 中转内核入口
- `sstatus` = S 态屏蔽中断

## 执行用户程序

1. 主内核填写共享用户上下文，内容包括基本任务上下文和用户根页表；
2. 主内核执行中转内核上下文，切换到中转内核线程
3. 中转内核切换上下文 CSR：`satp`、`stvec`、`sscratch`
   - 初次进入时还要将 `a0`、`a1`、`a2` 保存在栈上
   - 完成时到达用户空间
4. 执行共享用户上下文

## 处理用户陷入

1. 用户陷入到中转内核的 `trap`
   > 用户上下文已被保存在共享上下文区域
2. 中转内核切换上下文 CSR：`satp`、`stvec`、`sscratch`
   - 完成时回到内核空间
3. 模拟中断操作设置 `sepc`
4. 直接跳转内核的 `stvec` 回到主内核
